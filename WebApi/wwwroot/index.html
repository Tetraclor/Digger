<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Game Bot Arena</title>
    <style>
        body {
            height: 100vh;
            width: 100vw;
            display: flex;
			flex-direction: row;
			
            justify-content: center;
            align-items: center;
            margin: 0;
            background-color: beige;
            font-family: Consolas;
        }

        #main{
            display: flex;
            flex-direction: row-reverse;
        }

        #nav{
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            height: 80vh;
        }

        canvas{

            background-color: aquamarine;
        }

        #create-game-box{
            display: flex;
            flex-direction: column;
        }

        .item {
            margin: 10px;
        }

        table {
            font-family: arial, sans-serif;
            border-collapse: collapse;
            width: 100%;
        }

        td, th {
            border: 1px solid #dddddd;
            text-align: left;
            padding: 8px;
        }

        tr:nth-child(even) {
            background-color: #dddddd;
        }
    </style>
</head>
<body>
    <div id="main">
        <div id="create-game-box" class="item">
            <h2 class="item">Создание игры</h2>
            <div class="item">
                <span>Кол-во яблок:</span>
                <input type="number" id="apples-count" class="nav-item" value="10" onchange="window.applesCount = parseInt(this.value)" />
            </div>
            <table id="members" class="item">
                <caption> Участники </caption>
                <tr>
                    <th>Игрок</th>
                    <th>Рейтинг</th>
                    <th></th>
                </tr>
            </table>
            <div class="item">
                <span>Выбор карты:</span>
                <select id="map-choise" onchange="draw_map()">
                </select>
            </div>
            <canvas id="map-canvas"></canvas>
            <div class="item">
                <button onclick="create_game()">СОЗДАТЬ ИГРУ</button>
            </div>
        </div>

        <div id="nav" class="item">
            <table id="players">
                <caption>
                    Список игроков
                </caption>
                <tr>
                    <th>Игрок</th>
                    <th>Рейтинг</th>
                    <th>Вызов</th>
                </tr>
            </table>
            <table id="games">
                <caption>
                    Список идущих игр
                </caption>
                <tr>
                    <th>Игра</th>
                    <th>Карта</th>
                    <th>Игроки</th>
                    <th>Cмотреть</th>
                </tr>
            </table>
           <div id="message-box">

           </div>
        </div>
    </div>

    <script src="js/signalr/dist/browser/signalr.min.js"></script>
    <script src="js/draw.js"></script>
    <script src="https://code.jquery.com/jquery-1.9.1.min.js"></script>
    
    <script>
        $(document).ready(function () {
            console.log("document loaded");

            hubConnection.start()
                .then(async function () {
                    console.log("websocket connected");
                    await update_maps();
                    console.log("map updated");
                    await update_games();
                    console.log("games updated");
                    await update_players();
                });
        });

        window.members = [];

        function onclick_join_game(cell) {
            var r = cell.parentElement.parentElement.cells;
            var table = $('#members')[0];
            var row = table.insertRow();
            var player = r[0].innerText;
            var rate = r[1].innerText;
            var index = members.push({ name: player, row: row, index: members.length }) - 1;
            row.innerHTML = (`<td>${player}</td>
                        <td>${rate}</td>
                        <td><button onclick="exclude_game(${index})">Исключить</button></td>`);
        }

        function join_game() {

            var index = members.push({ name: player, row: row, index: members.length }) - 1;
            row.innerHTML = (`<td>${player}</td>
                        <td>${rate}</td>
                        <td><button onclick="exclude_game(${index})">Исключить</button></td>`);
        }

        function exclude_game(index) {
            var member = window.members.find(v => v.index === index);
            index = window.members.indexOf(member);
            if (index > -1) {
                window.members.splice(index, 1);
            }
            member.row.remove();
            console.log(window.members);
        }

        function create_game() {
            var players = window.members.map(v => v.name);

            console.log(players);

            var gameId = makeid(5);

            console.log(gameId);

            hubConnection.invoke("StartGame", {
                mapName: get_choised_mapinfo().name,
                gameId: gameId,
                applesCount: window.applesCount,
                players: players

            }).then(() => {
                window.open(`game.html?game_id=${gameId}`);
                //location.href = `game.html?game_id=${gameId}`;
            });
        }

        window.applesCount = 10;

        const hubConnection = new signalR.HubConnectionBuilder()
            .withUrl("/main")
            .build();

        hubConnection.on("ShowMessage", (msg) => {
            console.log(`Сообщение с сервера: ${msg}`);
        });

        async function update_games() {
            var games = await hubConnection.invoke("GetGames");
            var table = $('#games')[0];
            for (var i = 0; i < games.length; i++) {
                var row = table.insertRow();
                var info = games[i];
                row.innerHTML = `<td>Snake</td >
                        <td>${info.mapName}</td>
                        <td>${info.players}</td>
                        <td><a href="game.html?game_id=${info.gameId}">Смотреть</a></td>`;
            }

            console.log(games);
        }

        async function update_players() {
            var players = await hubConnection.invoke("GetPlayers");

            var table = $('#players')[0];
            for (var i = 0; i < players.length; i++) {
                var row = table.insertRow();
                var player = players[i];
                row.innerHTML = `
                        <td>${player.name}</td>
                        <td>${player.rate}</td>
                        <td><button onclick="onclick_join_game(this)">Вызвать</button></td>`;
            }

            console.log(players);
        }

        async function update_maps() {
            var select = document.getElementById("map-choise");
            document.maps = await hubConnection.invoke("GetMaps");
            var result = document.maps;

            for (var i = 0; i < result.length; i++) {

                select.appendChild(new Option(result[i].name));
            }
            await draw_map();
        }

        function get_choised_mapinfo() {
            return document.maps[document.getElementById("map-choise").selectedIndex];
        }

        async function draw_map() {
            var stringmap = get_choised_mapinfo().map;
            var map_canvas = document.getElementById("map-canvas");
            console.log(map_canvas);
            await draw_board(map_canvas, stringmap, 320, 320);
        }

        function makeid(length) {
            var result = '';
            var characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            var charactersLength = characters.length;
            for (var i = 0; i < length; i++) {
                result += characters.charAt(Math.floor(Math.random() *
                    charactersLength));
            }
            return result;
        }
    </script>
</body>
</html>