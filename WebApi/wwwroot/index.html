<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Game Bot Arena</title>
    <style>
        body {
            height: 100vh;
            width: 100vw;
            display: flex;
			flex-direction: row;
			
            justify-content: center;
            align-items: center;
            margin: 0;
            background-color: beige;
            font-family: Consolas;
        }

        header {
            display: flex;
            flex-direction: row;
            justify-content: space-between;

            position: absolute;
            background-color: gray;
            top: 0px;
            width: 100vw;
        }

        header div {
            display: flex;
            align-items: center;
        }

        header button{
            height: 70%;
        }

        #main{
            display: flex;
            flex-direction: row-reverse;
        }

        #nav{
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            height: 80vh;
        }

        #auth{
            display: none;
            flex-direction: column;
            position: fixed;
            background-color: gray;
            padding: 20px;
            border-radius: 2px;
        }

        canvas{
            background-color: aquamarine;
        }

        #create-game-box{
            display: flex;
            flex-direction: column;
        }

        .item {
            margin: 10px;
        }

        .overflow {
            overflow: scroll;
            max-height: 300px;
            overflow-x: hidden;
            overflow-y:auto;
        }

        table {
            font-family: arial, sans-serif;
            border-collapse: collapse;
            width: 100%;
        }

        th{
           
        }

        td, th {
            border: 1px solid #dddddd;
            text-align: left;
            padding: 8px;
        }

        tr:nth-child(even) {
            background-color: #dddddd;
        }
    </style>
</head>
<body>
    <header>
        <h3 class="item">SnakeArena</h3>
        <div>
            <h4 id="user-name"></h4>
            <button class="item" onclick="show_auth()">Авторизоваться</button>
        </div>
    </header>

    <div id="main">
        <div class="item overflow">
            <table id="members" class="">
                <caption> Участники </caption>
                <tr>
                    <th>Игрок</th>
                    <th>Рейтинг</th>
                    <th></th>
                </tr>
            </table>
        </div>
        <div id="create-game-box" class="item">
            <h2 class="item">Создание игры</h2>
            <div class="item">
                <span>Тиков до конца игры:</span>
                <input type="number" id="ticks-to-end" class="nav-item" value="1000" />
            </div>
            <div class="item">
                <span>Кол-во яблок:</span>
                <input type="number" id="apples-count" class="nav-item" value="10" />
            </div>

            <div class="item">
                <span>Выбор карты:</span>
                <select id="map-choise" onchange="draw_map()">
                </select>
            </div>
            <canvas id="map-canvas"></canvas>
            <div class="item">
                <p>Количество копий запусков (для тестирования)</p>
                <input type="number"  id="game-copy" class="nav-item" value="1" />
                <button onclick="create_copies_game()">СОЗДАТЬ ИГРУ</button>
            </div>
        </div>
            
        <div id="nav" class="item">
            <div class="overflow">
                <table id="players" class="overflow">
                    <caption>
                        Список игроков
                    </caption>
                    <tr>
                        <th>Игрок</th>
                        <th>Рейтинг</th>
                        <th>Вызов</th>
                    </tr>
                </table>
            </div>

            <div class="overflow">
                <table id="games">
                    <caption>
                        Список идущих игр
                    </caption>
                    <tr>
                        <th>Игра</th>
                        <th>Карта</th>
                        <th>Игроки</th>
                        <th>Состояние</th>
                        <th></th>
                    </tr>
                </table>
            </div>

            <div id="message-box">

            </div>
        </div>
    </div>

    <div id="auth" hidden>   
        <span>Имя</span><input class="item" id="login" type="text" value="TestUser" />
        <span>Пароль</span><input class="item" id="password" type="password" value="0" />
        <button class="item" onclick="login();">Авторизоваться</button>
        <button class="item" onclick="reg();">Зарегисрироваться</button>
    </div>

    <script src="js/signalr/dist/browser/signalr.min.js"></script>
    <script src="js/draw.js"></script>
    <script src="https://code.jquery.com/jquery-1.9.1.min.js"></script>
    
    <script>
        $(document).ready(function () {
            console.log("document loaded");

            hubConnection.start()
                .then(async function () {
                    console.log("websocket connected");
                    await update_maps();
                    console.log("map updated");
                    await update_games();
                    console.log("games updated");
                    await update_players();
                });
        });

        window.members = [];

        function show_auth() {
            form = $('#auth')[0];
          
            form.hidden = false;
            form.style.display = 'flex';
        }

        function hide_auth() {
            form = $('#auth')[0];
           
            form.hidden = true;
            form.style.display = 'none';
        }

        async function login() {
            var login = $('#login')[0].value;
            var password = $('#password')[0].value;

            var result = await fetch(`api/login?login=${login}&password=${password}`)
            var answer = await result.text();

            if (!result.ok) {
                show_error(answer);
                return;
            }

            location.reload();
        }

        async function reg() {
            var login = $('#login')[0].value;
            var password = $('#password')[0].value;

            var result = await fetch(`api/reg?login=${login}&password=${password}`)
            var answer = await result.text();

            if (!result.ok) {
                show_error(answer);
                return;
            }
            
            location.reload();
        }

        function show_error(msg) {
            alert(msg);
        }

        function onclick_join_game(cell) {
            var r = cell.parentElement.parentElement.cells;
            var table = $('#members')[0];
            var row = table.insertRow();
            var player = r[0].innerText;
            var rate = r[1].innerText;
            var index = members.push({ name: player, row: row, index: members.length }) - 1;
            row.innerHTML = (`<td>${player}</td>
                        <td>${rate}</td>
                        <td><button onclick="exclude_game(${index})">Исключить</button></td>`);
        }

        function join_game() {

            var index = members.push({ name: player, row: row, index: members.length }) - 1;
            row.innerHTML = (`<td>${player}</td>
                        <td>${rate}</td>
                        <td><button onclick="exclude_game(${index})">Исключить</button></td>`);
        }

        function exclude_game(index) {
            var member = window.members.find(v => v.index === index);
            index = window.members.indexOf(member);
            if (index > -1) {
                window.members.splice(index, 1);
            }
            member.row.remove();
            console.log(window.members);
        }

        function create_copies_game() {

            var count = parseInt($('#game-copy')[0].value);
            var open_window = count <= 10; // Не открывать окна если запущено копий больше 10

            for (var i = 0; i < count; i++) {
                console.log(open_window);
                create_game(open_window);
            }
        }

        function create_game(open_window) {
            var players = window.members.map(v => v.name);

            var gameId = makeid(5);

            var ticksToEnd = parseInt($('#ticks-to-end')[0].value);
            var applesCount = parseInt($('#apples-count')[0].value);

            return hubConnection.invoke("StartGame", {
                mapName: get_choised_mapinfo().name,
                gameId: gameId,
                applesCount: applesCount,
                players: players,
                ticksToEnd: ticksToEnd

            }).then(() => {
                console.log(open_window);
                if (open_window)
                    window.open(`game.html?game_id=${gameId}`);
                //location.href = `game.html?game_id=${gameId}`;
            });
        }

        const hubConnection = new signalR.HubConnectionBuilder()
            .withUrl("/main")
            .configureLogging(signalR.LogLevel.Information)
            .withAutomaticReconnect()
            .build();

        hubConnection.on("ShowMessage", (msg) => {
            console.log(`Сообщение с сервера: ${msg}`);
        });

        async function update_games() {
            var games = await hubConnection.invoke("GetGames");
            var table = $('#games')[0];

            var get_game_state = (inf) => {
                if (inf.isOver) return "Заверешена";
                if (inf.isNotStarted) return "Не запущена";
                if (inf.isInProgress) return "В процессе";
            }

            for (var i = 0; i < games.length; i++) {
                var row = table.insertRow();
                var info = games[i];
                row.innerHTML = `<td>Snake</td >
                        <td>${info.mapName}</td>
                        <td>${info.players}</td>
                        <td>${get_game_state(info)}</td>
                        <td><a href="game.html?game_id=${info.gameId}">Смотреть</a></td>`;
            }

            console.log(games);
        }

        async function update_players() {
            var players = await hubConnection.invoke("GetPlayers");
            var myPlayer = await hubConnection.invoke("GetMe");
            var myToken = await hubConnection.invoke("GetMyToken");
            $('#user-name')[0].innerText = `${myToken} ${myPlayer.name} ${myPlayer.rate}`;

            var table = $('#players')[0];
            for (var i = 0; i < players.length; i++) {
                var row = table.insertRow();
                var player = players[i];
                row.innerHTML = `
                        <td>${player.name}</td>
                        <td>${player.rate}</td>
                        <td><button onclick="onclick_join_game(this)">Вызвать</button></td>`;
            }

            console.log(players);
        }

        async function update_maps() {
            var select = document.getElementById("map-choise");
            document.maps = await hubConnection.invoke("GetMaps");
            var result = document.maps;

            for (var i = 0; i < result.length; i++) {

                select.appendChild(new Option(result[i].name));
            }
            await draw_map();
        }

        function get_choised_mapinfo() {
            return document.maps[document.getElementById("map-choise").selectedIndex];
        }

        async function draw_map() {
            var stringmap = get_choised_mapinfo().map;
            var map_canvas = document.getElementById("map-canvas");
            console.log(map_canvas);
            await draw_board(map_canvas, stringmap, 320, 320);
        }

        function makeid(length) {
            var result = '';
            var characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            var charactersLength = characters.length;
            for (var i = 0; i < length; i++) {
                result += characters.charAt(Math.floor(Math.random() *
                    charactersLength));
            }
            return result;
        }
    </script>
</body>
</html>