<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor" crossorigin="anonymous">
    <title>SnakeArena</title>
    <style>
        body {
            box-shadow: inset 0px 0px 10px black;
            background: rgb(241, 241, 241);
            min-height: 100vh;
        }

        table {
            background: rgb(255, 255, 255);
            border: 1px solid black;
            /*       box-shadow: 0px 0px 5px black;*/
        }

        .overflow {
            overflow: scroll;
            max-height: 250px;
            overflow-x: hidden;
            overflow-y: auto;
        }

        #canvas {
            background-color: dimgrey;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="p-2">
        <div class="container">
            <div class="row d-flex align-items-center justify-content-center justify-content-md-between py-1  border-bottom">

                <a href="/" class="col-12 col-md text-md-start text-center text-decoration-none text-dark">
                    <img class="me-3" src="logo.png" />
                    <span class="h4">SnakeArena</span>
                </a>

                <ul class="nav col-md-4 justify-content-center">
                    <li><span id="user-name" class="nav-link px-2 text-black">Login</span></li>
                </ul>

                <div class="col-md-2 text-center">
                    <button type="button" class="btn" data-bs-toggle="modal" data-bs-target="#authModal">Авторизироваться</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Modal -->
    <div class="modal fade" id="authModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Авторизация</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <span class="form-label">Имя</span><input class="form-control mb-3" id="login" type="text" value="TestUser" />
                    <span class="form-label">Пароль</span><input class="form-control mb-3" id="password" type="password" value="0" />
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="login()">Авторизоваться</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="reg()">Зарегестрироваться</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Content -->
    <div class="container mt-4">
        <div class="row">
            <div class="col-12 me-5 col-lg-4">

                <div class="mt-4" id="inputForm">
                    <input class="form-control mb-3" type="button" id="startBtn" value="Начать игру" onclick="start_game()" />
                    <input class="form-control" type="button" id="stopBtn" value="Остановить игру" onclick="stop_game()" />
                </div>

                <div class="ms-2" id="game-info">
                    <div class="mt-3">
                        <b>Карта: </b><span id="map-name"></span>
                    </div>
                    <div class="mt-3">
                        <b>Состояние игры: </b><span id="game-state"></span>
                    </div>
                    <div class="mt-3">
                        <b>Ограничение по тикам: </b><span id="ticks-to-end"></span>
                    </div>
                    <div class="mt-3">
                        <b>Кол-во яблок: </b><span id="apples-count"></span>
                    </div>
                    <div class="mt-3">
                        <b>Game Tick: </b><span id="tick" class="">0</span>
                    </div>
                </div>

                <div class="mt-3">
                    <table class="table" id="players" cellspacing="10">
                        <tr>
                            <th scope="col">№</th>
                            <th scope="col" align="left">Player Name</th>
                            <th scope="col" align="right">Score</th>
                        </tr>
                    </table>
                </div>
            </div>

            <div class="col-12 col-lg">
                <canvas id="canvas"></canvas>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-pprn3073KE6tl6bjs2QrFaJGz5/SUsLqktiwsUTF55Jfv3qYSDhgCecCxMW52nD2" crossorigin="anonymous"></script>
    <script src="js/signalr/dist/browser/signalr.min.js"></script>
    <script src="https://code.jquery.com/jquery-1.9.1.min.js"></script>
    <script src="js/draw.js"></script>
    <script src="js/common.js"></script>

    <script>
        var bot;
        var user_command;

        document.addEventListener('keydown', function (e) {
            if (e.keyCode == '38') {
                window.user_command = 'up';
            }
            else if (e.keyCode == '40') {
                window.user_command = 'down';
            }
            else if (e.keyCode == '37') {
                window.user_command = 'left';
            }
            else if (e.keyCode == '39') {
                window.user_command = 'right';
            }
        });

        async function doimport() {
            var moduleData = document.getElementById("bot_script");
            console.log(moduleData);
            var b64moduleData = "data:text/javascript;base64," + btoa(moduleData);
            window.bot = await import(b64moduleData);
            window.bot.tick();
        }

        function bot_act() {
            // window.bot.tick();

            var temp = window.user_command;
            window.user_command = null;
            return temp;
        }

        const hubConnection = new signalR.HubConnectionBuilder()
            .withUrl("/game")
            .build();

        hubConnection.on("Receive", async function (game) {
            var map = game.map;
            var tick = game.tick;
            var playrs_info = game.playersScores;
            var gameState = game.gameState;

            var command = bot_act();
            await hubConnection.invoke("SendTurn", command);

            document.getElementById("tick").innerText = tick;

            update_scores(playrs_info);

            await draw_board(document.getElementById('canvas'), game, 700, 700);
        });

        hubConnection.start()
            .then(async () => await update_my())
            .then(() => start_game()) // Для быстрого тестирования


        function start_game() {
            hubConnection.invoke("StartGame", params.game_id)
                .then(v => set_game_info(v));
        }

        function set_game_info(game_info) {
            document.getElementById('ticks-to-end').innerText = game_info.ticksToEnd;
            document.getElementById('map-name').innerText = game_info.mapName;
            document.getElementById('apples-count').innerText = game_info.applesCount;

            var get_game_state = (inf) => {
                if (inf.isOver) return "Заверешена";
                if (inf.isNotStarted) return "Не запущена";
                if (inf.isInProgress) return "В процессе";
            }

            document.getElementById('game-state').innerText = get_game_state(game_info);
        }

        function stop_game() {
            hubConnection.invoke("StopGame", params.game_id);
        }

        function update_scores(playrs_info) {
            playrs_info = playrs_info.sort((a, b) => b.score - a.score);

            var table = document.getElementById("players");

            for (var i = table.rows.length; i < playrs_info.length + 1; i++) {
                var row = table.insertRow();
                row.innerHTML = `<td></td>
                                            <td></td>
                                            <td align="right"></td>`;
            }

            for (var i = 0; i < playrs_info.length; i++) {
                var info = playrs_info[i];
                var cells = table.rows[i + 1].children;

                cells[0].innerText = i + 1;
                cells[1].innerText = info.name;
                cells[2].innerText = info.score;
            }
        }

        const params = new Proxy(new URLSearchParams(window.location.search), {
            get: (searchParams, prop) => searchParams.get(prop),
        });
        // Get the value of "some_key" in eg "https://example.com/?some_key=some_value"
        console.log(params.game_id);
    </script>
</body>
</html>